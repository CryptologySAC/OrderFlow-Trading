<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Detector Backtesting Results</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            header {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 40px;
                text-align: center;
            }

            h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            .subtitle {
                font-size: 1.2em;
                opacity: 0.9;
                margin-bottom: 30px;
            }

            .summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 30px;
            }

            .stat-card {
                background: rgba(255, 255, 255, 0.1);
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                backdrop-filter: blur(10px);
            }

            .stat-card h3 {
                font-size: 0.9em;
                margin-bottom: 10px;
                opacity: 0.8;
            }
            .stat-value {
                font-size: 2em;
                font-weight: bold;
            }

            section {
                padding: 40px;
                border-bottom: 1px solid #eee;
            }

            section:last-child {
                border-bottom: none;
            }

            h2 {
                font-size: 1.8em;
                margin-bottom: 30px;
                color: #2c3e50;
            }

            .loading {
                text-align: center;
                padding: 60px;
                color: #666;
            }

            .loading-spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                animation: spin 1s linear infinite;
                margin: 20px auto;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .error {
                background: #f8d7da;
                color: #721c24;
                padding: 20px;
                border-radius: 10px;
                margin: 20px;
            }

            .upload-area {
                border: 2px dashed #ccc;
                border-radius: 10px;
                padding: 40px;
                text-align: center;
                margin: 20px;
                cursor: pointer;
                transition: border-color 0.3s;
            }

            .upload-area:hover {
                border-color: #3498db;
            }

            .upload-area.dragover {
                border-color: #3498db;
                background: #f0f8ff;
            }

            input[type="file"] {
                display: none;
            }

            .button {
                background: #3498db;
                color: white;
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px;
                transition: background 0.3s;
            }

            .button:hover {
                background: #2980b9;
            }

            .button:disabled {
                background: #bdc3c7;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>üéØ Detector Backtesting Results</h1>
                <p class="subtitle">
                    Interactive Performance Analysis Dashboard
                </p>
            </header>

            <section id="upload-section">
                <h2>üìÅ Load Results</h2>
                <div class="upload-area" id="upload-area">
                    <h3>üìä Drop results files here or click to select</h3>
                    <p>
                        Upload performance_results.csv, test_results.csv, or
                        optimal_configurations.json
                    </p>
                    <input
                        type="file"
                        id="file-input"
                        accept=".csv,.json"
                        multiple
                    />
                    <button
                        class="button"
                        onclick="document.getElementById('file-input').click()"
                    >
                        Select Files
                    </button>
                </div>
                <div id="file-status"></div>
            </section>

            <section id="results-section" style="display: none">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading and analyzing results...</p>
                </div>
            </section>
        </div>

        <script>
            class BacktestingDashboard {
                constructor() {
                    this.data = {
                        performance: null,
                        tests: null,
                        optimal: null,
                    };
                    this.setupEventListeners();
                }

                setupEventListeners() {
                    const uploadArea = document.getElementById("upload-area");
                    const fileInput = document.getElementById("file-input");

                    // Drag and drop
                    uploadArea.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        uploadArea.classList.add("dragover");
                    });

                    uploadArea.addEventListener("dragleave", () => {
                        uploadArea.classList.remove("dragover");
                    });

                    uploadArea.addEventListener("drop", (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove("dragover");
                        this.handleFiles(e.dataTransfer.files);
                    });

                    // File input
                    fileInput.addEventListener("change", (e) => {
                        this.handleFiles(e.target.files);
                    });

                    // Click to upload
                    uploadArea.addEventListener("click", () => {
                        fileInput.click();
                    });
                }

                async handleFiles(files) {
                    const fileStatus = document.getElementById("file-status");
                    fileStatus.innerHTML = "<p>Processing files...</p>";

                    for (const file of files) {
                        try {
                            const content = await this.readFile(file);

                            if (file.name.includes("performance_results.csv")) {
                                this.data.performance = this.parseCSV(content);
                            } else if (file.name.includes("test_results.csv")) {
                                this.data.tests = this.parseCSV(content);
                            } else if (
                                file.name.includes(
                                    "optimal_configurations.json"
                                )
                            ) {
                                this.data.optimal = JSON.parse(content);
                            }
                        } catch (error) {
                            console.error(
                                "Error processing file:",
                                file.name,
                                error
                            );
                            fileStatus.innerHTML += `<div class="error">Error processing ${file.name}: ${error.message}</div>`;
                        }
                    }

                    if (this.data.performance) {
                        this.showResults();
                    } else {
                        fileStatus.innerHTML +=
                            '<div class="error">No performance results found. Please upload performance_results.csv</div>';
                    }
                }

                readFile(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                }

                parseCSV(content) {
                    const lines = content.trim().split("\n");
                    const headers = lines[0].split(",");
                    const data = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(",");
                        const row = {};
                        headers.forEach((header, index) => {
                            const value = values[index];
                            // Try to parse as number
                            if (!isNaN(value) && value !== "") {
                                row[header] = parseFloat(value);
                            } else {
                                row[header] = value;
                            }
                        });
                        data.push(row);
                    }

                    return data;
                }

                showResults() {
                    document.getElementById("upload-section").style.display =
                        "none";
                    document.getElementById("results-section").style.display =
                        "block";

                    // Generate results content
                    this.generateResultsContent();
                }

                generateResultsContent() {
                    const resultsSection =
                        document.getElementById("results-section");

                    // Sort by F1 score
                    const sortedResults = this.data.performance.sort(
                        (a, b) => b.f1Score - a.f1Score
                    );
                    const topResults = sortedResults.slice(0, 10);

                    // Calculate summary stats
                    const totalConfigs = this.data.performance.length;
                    const avgF1 =
                        this.data.performance.reduce(
                            (sum, r) => sum + r.f1Score,
                            0
                        ) / totalConfigs;
                    const bestF1 = sortedResults[0]?.f1Score || 0;
                    const avgSignals =
                        this.data.performance.reduce(
                            (sum, r) => sum + r.totalSignals,
                            0
                        ) / totalConfigs;

                    // Group by detector type
                    const byDetector = {};
                    this.data.performance.forEach((result) => {
                        if (!byDetector[result.detectorType]) {
                            byDetector[result.detectorType] = [];
                        }
                        byDetector[result.detectorType].push(result);
                    });

                    resultsSection.innerHTML = `
                    <header style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 40px; text-align: center;">
                        <h1>üèÜ Backtesting Results Analysis</h1>
                        <p class="subtitle">Performance analysis across ${totalConfigs} configurations</p>
                        <div class="summary-stats">
                            <div class="stat-card">
                                <h3>Total Configurations</h3>
                                <span class="stat-value">${totalConfigs}</span>
                            </div>
                            <div class="stat-card">
                                <h3>Best F1 Score</h3>
                                <span class="stat-value">${bestF1.toFixed(3)}</span>
                            </div>
                            <div class="stat-card">
                                <h3>Average F1 Score</h3>
                                <span class="stat-value">${avgF1.toFixed(3)}</span>
                            </div>
                            <div class="stat-card">
                                <h3>Avg Signals</h3>
                                <span class="stat-value">${avgSignals.toFixed(1)}</span>
                            </div>
                        </div>
                    </header>

                    <section>
                        <h2>ü•á Top 10 Performing Configurations</h2>
                        ${this.generateTopResultsTable(topResults)}
                    </section>

                    <section>
                        <h2>üìä Performance by Detector Type</h2>
                        ${this.generateDetectorComparison(byDetector)}
                    </section>

                    ${this.data.optimal ? this.generateOptimalConfigSection() : ""}
                `;
                }

                generateTopResultsTable(results) {
                    const headers = [
                        "Rank",
                        "Config ID",
                        "Detector",
                        "F1 Score",
                        "Precision",
                        "Recall",
                        "Accuracy",
                        "Signals",
                        "True Pos",
                        "False Pos",
                    ];

                    const rows = results
                        .map(
                            (result, index) => `
                    <tr>
                        <td style="font-weight: bold; background: #ecf0f1; text-align: center;">${index + 1}</td>
                        <td>${result.configId}</td>
                        <td>${result.detectorType}</td>
                        <td class="${this.getScoreClass(result.f1Score)}">${result.f1Score.toFixed(3)}</td>
                        <td class="${this.getScoreClass(result.precision)}">${result.precision.toFixed(3)}</td>
                        <td class="${this.getScoreClass(result.recall)}">${result.recall.toFixed(3)}</td>
                        <td class="${this.getScoreClass(result.accuracy)}">${result.accuracy.toFixed(3)}</td>
                        <td>${result.totalSignals}</td>
                        <td>${result.truePositives}</td>
                        <td>${result.falsePositives}</td>
                    </tr>
                `
                        )
                        .join("");

                    return `
                    <div style="overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #3498db; color: white;">
                                    ${headers.map((h) => `<th style="padding: 15px 10px; text-align: left; font-weight: 600;">${h}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
                }

                generateDetectorComparison(byDetector) {
                    let html = "";

                    for (const [detectorType, results] of Object.entries(
                        byDetector
                    )) {
                        const avgF1 =
                            results.reduce((sum, r) => sum + r.f1Score, 0) /
                            results.length;
                        const avgPrecision =
                            results.reduce((sum, r) => sum + r.precision, 0) /
                            results.length;
                        const avgRecall =
                            results.reduce((sum, r) => sum + r.recall, 0) /
                            results.length;
                        const totalSignals = results.reduce(
                            (sum, r) => sum + r.totalSignals,
                            0
                        );
                        const bestResult = results.sort(
                            (a, b) => b.f1Score - a.f1Score
                        )[0];

                        html += `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 30px; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3em;">${detectorType} (${results.length} configurations)</h3>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                                <span style="background: #3498db; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold;">
                                    Best F1: ${bestResult.f1Score.toFixed(3)}
                                </span>
                                <span style="background: #2ecc71; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold;">
                                    Avg F1: ${avgF1.toFixed(3)}
                                </span>
                                <span style="background: #e74c3c; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold;">
                                    Total Signals: ${totalSignals}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #3498db;">${avgPrecision.toFixed(3)}</div>
                                    <div style="font-size: 0.9em; color: #666;">Avg Precision</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #2ecc71;">${avgRecall.toFixed(3)}</div>
                                    <div style="font-size: 0.9em; color: #666;">Avg Recall</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #9b59b6;">${avgF1.toFixed(3)}</div>
                                    <div style="font-size: 0.9em; color: #666;">Avg F1 Score</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: #e67e22;">${bestResult.configId}</div>
                                    <div style="font-size: 0.9em; color: #666;">Best Config</div>
                                </div>
                            </div>
                        </div>
                    `;
                    }

                    return html;
                }

                generateOptimalConfigSection() {
                    const optimal = this.data.optimal;

                    return `
                    <section>
                        <h2>‚öôÔ∏è Optimal Configurations</h2>
                        <div style="background: #e8f5e8; border-radius: 10px; padding: 30px; margin-bottom: 20px;">
                            <h3 style="color: #27ae60; margin-bottom: 15px;">üèÜ Overall Best Performer</h3>
                            <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60;">
                                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">${optimal.bestOverall.configId}</div>
                                <div style="margin-bottom: 10px;"><strong>Detector:</strong> ${optimal.bestOverall.detectorType}</div>
                                <div style="margin-bottom: 10px;"><strong>Profile:</strong> ${optimal.bestOverall.profile}</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                                    <div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #3498db;">${optimal.bestOverall.metrics.precision.toFixed(3)}</div>
                                        <div style="font-size: 0.8em; color: #666;">Precision</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #2ecc71;">${optimal.bestOverall.metrics.recall.toFixed(3)}</div>
                                        <div style="font-size: 0.8em; color: #666;">Recall</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #9b59b6;">${optimal.bestOverall.score.toFixed(3)}</div>
                                        <div style="font-size: 0.8em; color: #666;">F1 Score</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #e67e22;">${optimal.bestOverall.metrics.directionAccuracy.toFixed(3)}</div>
                                        <div style="font-size: 0.8em; color: #666;">Direction Acc</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; border-radius: 10px; padding: 30px;">
                            <h3 style="color: #856404; margin-bottom: 15px;">üìà Summary Statistics</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #3498db;">${optimal.summary.totalConfigurations}</div>
                                    <div style="color: #666;">Total Configs</div>
                                </div>
                                <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${optimal.summary.bestF1Score.toFixed(3)}</div>
                                    <div style="color: #666;">Best F1 Score</div>
                                </div>
                                <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #e67e22;">${optimal.summary.avgF1Score.toFixed(3)}</div>
                                    <div style="color: #666;">Avg F1 Score</div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;
                }

                getScoreClass(score) {
                    if (score >= 0.8) return "high-score";
                    if (score >= 0.6) return "medium-score";
                    return "low-score";
                }
            }

            // Initialize dashboard
            document.addEventListener("DOMContentLoaded", () => {
                new BacktestingDashboard();
            });
        </script>

        <style>
            .high-score {
                background: #d4edda;
                color: #155724;
                font-weight: bold;
            }
            .medium-score {
                background: #fff3cd;
                color: #856404;
            }
            .low-score {
                background: #f8d7da;
                color: #721c24;
            }

            table tr:hover {
                background: #f8f9fa !important;
            }

            table td {
                padding: 12px 10px;
                border-bottom: 1px solid #eee;
            }
        </style>
    </body>
</html>
